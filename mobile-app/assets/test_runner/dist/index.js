(()=>{"use strict";function t({messenger:t,message:e}){return new Promise((s=>{const r=new MessageChannel;r.port1.onmessage=t=>{r.port1.close(),s(t.data)},t.postMessage(e,{targetOrigin:"*",transfer:[r.port2]})}))}const e=(t="/dist/")=>{const e=t.startsWith("/"),s=t.endsWith("/");return e||(t="/"+t),s||(t+="/"),t};class s{#t;#e;#s({assetPath:t,script:s}){const r=document.createElement("iframe");return r.sandbox.add("allow-scripts","allow-forms"),r.allow="autoplay",r.id="test-frame",(t=>{t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",t.style.visibility="hidden"})(r),{iframe:r,scriptHTML:`<script id='test-evaluator-script' src='${e(t)+s}'><\/script>`}}constructor(t){const{scriptHTML:e,iframe:s}=this.#s(t);this.#t=s,this.#e=e}async init(t){const{hooks:e}=t,s=e?.beforeAll?`<script id='test-evaluator-hooks'>\n${e.beforeAll}\n<\/script>`:"",r=new Promise((t=>{const e=()=>{this.#t.removeEventListener("load",e),t(!0)};this.#t.addEventListener("load",e)}));this.#t.srcdoc=`\n${this.#e}\n${s}\n${t.source}`,document.body.appendChild(this.#t),await r;const a=new Promise((t=>{const e=s=>{"null"===s.origin&&s.source===this.#t.contentWindow&&"ready"===s.data.type&&(window.removeEventListener("message",e),t(!0))};window.addEventListener("message",e)})),n={type:"init",value:t};this.#t.contentWindow?.postMessage(n,"*"),await a}runTest(e){return t({messenger:this.#t.contentWindow,message:{type:"test",value:e}}).then((({value:t})=>t))}dispose(){this.#t.remove()}}class r{#t;#r=null;#a="";#s({assetPath:t,script:s}){return this.#a=e(t)+s,new Worker(this.#a)}constructor(t){this.#t=this.#s(t)}async init(t){this.#r=t;const e=new Promise((t=>{const e=s=>{"ready"===s.data.type&&(this.#t.removeEventListener("message",e),t(!0))};this.#t.addEventListener("message",e)})),s={type:"init",value:t};this.#t.postMessage(s),await e}async#n(){if(!this.#r||!this.#a)throw new Error("WorkerTestRunner not initialized");this.#t=new Worker(this.#a),await this.init(this.#r)}async runTest(e,s=5e3){let r;const a=new Promise((t=>{r=setTimeout((()=>{this.dispose(),this.#n().then((()=>{t({err:{message:"Test timed out"}})}))}),s)})),n={type:"test",value:e},i=t({messenger:this.#t,message:n}).then((({value:t})=>t));try{return await Promise.race([i,a])}finally{clearTimeout(r)}}dispose(){this.#t.terminate()}}window.FCCTestRunner=new class{#i;#o;#c;constructor(){this.#i=null,this.#o=null,this.#c=null}getRunner(t){switch(t){case"dom":return this.#i;case"javascript":return this.#o;case"python":return this.#c}}async createTestRunner({source:t,type:e,code:a,assetPath:n,hooks:i,loadEnzyme:o}){let c=null;switch(e){case"dom":this.#i||=new s({assetPath:n,script:"dom-test-evaluator.js"}),c=this.#i;break;case"javascript":this.#o||=new r({assetPath:n,script:"javascript-test-evaluator.js"}),c=this.#o;break;case"python":this.#c||=new r({assetPath:n,script:"python-test-evaluator.js"}),c=this.#c}return await c.init({code:a,source:t,loadEnzyme:o,hooks:i}),c}}})();