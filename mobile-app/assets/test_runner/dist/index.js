(()=>{"use strict";function t({messenger:t,message:e}){return new Promise((s=>{const r=new MessageChannel;r.port1.onmessage=t=>{r.port1.close(),s(t.data)},t.postMessage(e,{targetOrigin:"*",transfer:[r.port2]})}))}const e=(t="/dist/")=>{const e=t.startsWith("/"),s=t.endsWith("/");return e||(t="/"+t),s||(t+="/"),t},s=t=>{if("fetch"===t.data.type){const{url:e,options:s}=t.data;fetch(e,{...s,credentials:"omit"}).then((async e=>{const s=await e.text();t.ports[0].postMessage({status:e.status,statusText:e.statusText,url:e.url,text:s})}))}};class r{#t;#e;#s;#r({assetPath:t,script:s}){const r=document.createElement("iframe");return r.sandbox.add("allow-scripts","allow-forms"),r.allow="autoplay",r.id="test-frame",{iframe:r,scriptHTML:`<script id='test-evaluator-script' src='${e(t)+s}'><\/script>`}}constructor(t){const{scriptHTML:e,iframe:r}=this.#r(t);this.#t=r,this.#e=e,this.#a("message",s)}#a(t,e){window.addEventListener("message",(t=>{"null"===t.origin&&t.source===this.#t.contentWindow&&e(t)}))}async init(e,s){const{hooks:r}=e,a=r?.beforeAll?`<script id='test-evaluator-hooks'>\n${r.beforeAll}\n<\/script>`:"";this.#s=r?.afterAll;const n=new Promise(((t,e)=>{const r=setTimeout((()=>e(Error("Timed out waiting for the test frame to load"))),s),a=()=>{this.#t.removeEventListener("load",a),clearTimeout(r),t(!0)};this.#t.addEventListener("load",a)}));var i;this.#t.srcdoc=`\n${this.#e}\n${a}\n${e.source}`,(i=this.#t).style.position="",i.style.left="",i.style.top="",i.style.visibility="",i.style.width="",i.style.height="",i.style.opacity="",i.style.pointerEvents="",e.allowAnimations?(t=>{t.style.width="0px",t.style.height="0px",t.style.opacity="0",t.style.pointerEvents="none"})(this.#t):(t=>{t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",t.style.visibility="hidden"})(this.#t),document.body.appendChild(this.#t),await n;const o={type:"init",value:e};await t({messenger:this.#t.contentWindow,message:o})}runTest(e){return t({messenger:this.#t.contentWindow,message:{type:"test",value:e}}).then((({value:t})=>t))}async#n(e){const s={type:"code",value:e};return t({messenger:this.#t.contentWindow,message:s})}async runAllTests(t){const e=[];for(const s of t){const t=await this.runTest(s);e.push(t)}return this.#s&&await this.#n(this.#s),e}dispose(){this.#t.remove()}}class a{#t;#i=null;#o;#l="";#r({assetPath:t,script:s}){return this.#l=e(t)+s,new Worker(this.#l)}constructor(t){this.#t=this.#r(t),this.#a("message",s)}#a(t,e){this.#t.addEventListener("message",e)}async init(e,s){this.#i=e,this.#o=s;const r={type:"init",value:e};let a;const n=new Promise(((t,e)=>{a=setTimeout((()=>e(new Error("Timed out waiting for the test worker to initialize"))),s)})),i=t({messenger:this.#t,message:r});await Promise.race([i,n]),clearTimeout(a)}async#u(){if(!this.#i||!this.#l)throw new Error("WorkerTestRunner not initialized");this.#t=new Worker(this.#l),await this.init(this.#i,this.#o)}async#n(e){const s={type:"code",value:e};return t({messenger:this.#t,message:s})}async runTest(e,s=5e3){let r;const a=new Promise((t=>{r=setTimeout((()=>{this.dispose(),this.#u().then((()=>{t({err:{message:"Test timed out"}})}))}),s)})),n={type:"test",value:e},i=t({messenger:this.#t,message:n}).then((({value:t})=>t));try{return await Promise.race([i,a])}finally{clearTimeout(r)}}async runAllTests(t,e=5e3){const s=[];for(const r of t){const t=await this.runTest(r,e);s.push(t)}return this.#i?.hooks?.afterAll&&await this.#n(this.#i.hooks.afterAll),s}dispose(){this.#t.terminate()}}window.FCCTestRunner=new class{#c;#h;#p;constructor(){this.#c=null,this.#h=null,this.#p=null}getRunner(t){switch(t){case"dom":return this.#c;case"javascript":return this.#h;case"python":return this.#p}}async createTestRunner({source:t,type:e,code:s,assetPath:n,hooks:i,loadEnzyme:o,allowAnimations:l},{timeout:u}={timeout:2e4}){let c=null;switch(e){case"dom":this.#c||=new r({assetPath:n,script:"dom-test-evaluator.js"}),c=this.#c;break;case"javascript":this.#h||=new a({assetPath:n,script:"javascript-test-evaluator.js"}),c=this.#h;break;case"python":this.#p||=new a({assetPath:n,script:"python-test-evaluator.js"}),c=this.#p}return await c.init({code:s,source:t,loadEnzyme:o,hooks:i,allowAnimations:l},u),c}}})();